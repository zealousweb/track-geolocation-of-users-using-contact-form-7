!function(e){"use strict";jQuery(document).ready((function(e){var o;console.log("CFGEO Debug: cfgeo_ajax available:","undefined"!=typeof cfgeo_ajax),"undefined"!=typeof cfgeo_ajax?console.log("CFGEO Debug: cfgeo_ajax data:",cfgeo_ajax):console.log("CFGEO Debug: cfgeo_ajax not available, some features may be limited"),console.log("CFGEO Debug: Advanced filters container found:",e(".cfgeo-advanced-filters").length),jQuery.fn.spectrum?jQuery("#cfgeo_color_picker").spectrum({type:"component",showPalette:!1,showSelectionPalette:!0,togglePaletteOnly:!0,hideAfterPaletteSelect:!0,showAlpha:!1,change:function(e){if(null==e)return jQuery(".cfgeo_color_picker").addClass("validation-error-geo"),!1;7==e.toHexString().length&&jQuery(".cfgeo_color_picker").removeClass("validation-error-geo")}}):console.log("CFGEO Debug: Spectrum plugin not available, skipping color picker initialization"),jQuery(".setting-geolocation input#submit").click((function(){if(jQuery.fn.spectrum&&jQuery(".cfgeo_color_picker").length>0){var e=jQuery(".cfgeo_color_picker").val();if(jQuery(".cfgeo_color_picker").hasClass("validation-error-geo")||null==e||""==e)return jQuery(".cfgeo_color_picker").addClass("validation-error-geo"),!1;if(7!=e.length)return jQuery(".cfgeo_color_picker").addClass("validation-error-geo"),!1}})),jQuery("#form-id-graph").change((function(){window.location=translate_string_geo.form_graph_url+this.value})),jQuery("#cfgeo-ipstack").on("mouseenter click",(function(){jQuery("body .wp-pointer-buttons .close").trigger("click"),jQuery("#cfgeo-ipstack").pointer({pointerClass:"wp-pointer cfgeo-pointer",content:translate_string_geo.ipstack,position:"left center"}).pointer("open")})),jQuery("#cfgeo-google").on("mouseenter click",(function(){jQuery("body .wp-pointer-buttons .close").trigger("click"),jQuery("#cfgeo-google").pointer({pointerClass:"wp-pointer cfgeo-pointer",content:translate_string_geo.google,position:"left center"}).pointer("open")})),jQuery("#cfgeo-debug").on("mouseenter click",(function(){jQuery("body .wp-pointer-buttons .close").trigger("click"),jQuery("#cfgeo-debug").pointer({pointerClass:"wp-pointer cfgeo-pointer",content:translate_string_geo.debug,position:"left center"}).pointer("open")})),jQuery("#cfgeo-color-graph").on("mouseenter click",(function(){jQuery("body .wp-pointer-buttons .close").trigger("click"),jQuery("#cfgeo-color-graph").pointer({pointerClass:"wp-pointer cfgeo-pointer",content:translate_string_geo.graphcolor,position:"left center"}).pointer("open")})),jQuery("#cfgeo-webhook-enabled").on("mouseenter click",(function(){jQuery("body .wp-pointer-buttons .close").trigger("click"),jQuery("#cfgeo-webhook-enabled").pointer({pointerClass:"wp-pointer cfgeo-pointer",content:translate_string_geo.webhook_enabled,position:"left center"}).pointer("open")})),jQuery("#cfgeo-webhook-urls").on("mouseenter click",(function(){jQuery("body .wp-pointer-buttons .close").trigger("click"),jQuery("#cfgeo-webhook-urls").pointer({pointerClass:"wp-pointer cfgeo-pointer",content:translate_string_geo.webhook_urls,position:"left center"}).pointer("open")})),jQuery("#cfgeo-webhook-secret").on("mouseenter click",(function(){jQuery("body .wp-pointer-buttons .close").trigger("click"),jQuery("#cfgeo-webhook-secret").pointer({pointerClass:"wp-pointer cfgeo-pointer",content:translate_string_geo.webhook_secret,position:"left center"}).pointer("open")}));var t=!1;function a(){if(console.log("performAjaxFilter called"),t)console.log("Already loading, skipping");else if(e(".cfgeo-advanced-filters").length){t=!0,e(".cfgeo-advanced-filters").addClass("loading"),e(".cfgeo-loading").show(),e(".cfgeo-filter-row input, .cfgeo-filter-row select").prop("disabled",!0),e(".wp-list-table tbody").html('<tr><td colspan="8" style="text-align: center; padding: 20px;"><div class="spinner is-active"></div> Loading...</td></tr>');var o={action:"cfgeo_filter_submissions",nonce:cfgeo_ajax.nonce,form_id:e("#form-id").val()||"all",country_filter:e("#country-filter").val()||"",city_filter:e("#city-filter").val()||"",date_from:e("#date-from").val()||"",date_to:e("#date-to").val()||"",search_term:e("#search-term").val()||"",orderby:e('input[name="orderby"]').val()||"date",order:e('input[name="order"]').val()||"DESC",paged:e('input[name="paged"]').val()||"1"};console.log("Sending AJAX request with data:",o),e.ajax({url:ajaxurl,type:"POST",data:o,success:function(t){if(t.success){if(e(".wp-list-table tbody").html(t.data.html),t.data.pagination?e(".tablenav-pages").html(t.data.pagination):e(".tablenav-pages").html(""),e(".cfgeo-filter-count").remove(),t.data.total>0){var a=e('<div class="cfgeo-filter-count">Showing '+t.data.total+" submission(s)</div>");e(".cfgeo-advanced-filters").append(a)}else{a=e('<div class="cfgeo-filter-count">No submissions found matching your criteria</div>');e(".cfgeo-advanced-filters").append(a)}var r=new URL(window.location);r.searchParams.set("form-id",o.form_id),r.searchParams.set("country-filter",o.country_filter),r.searchParams.set("city-filter",o.city_filter),r.searchParams.set("date-from",o.date_from),r.searchParams.set("date-to",o.date_to),r.searchParams.set("search-term",o.search_term),r.searchParams.set("orderby",o.orderby),r.searchParams.set("order",o.order),r.searchParams.set("paged",o.paged),window.history.pushState({},"",r)}else alert("Error: "+t.data)},error:function(e,o,t){console.log("AJAX Error:",e.responseText),alert(cfgeo_ajax.error_message)},complete:function(){t=!1,e(".cfgeo-advanced-filters").removeClass("loading"),e(".cfgeo-loading").hide(),e(".cfgeo-filter-row input, .cfgeo-filter-row select").prop("disabled",!1)}})}else console.log("Not on CFGEO page, skipping")}if(e(".cfgeo-advanced-filters").length&&"undefined"!=typeof cfgeo_ajax){console.log("CFGEO Debug: Initializing AJAX functionality"),e("#form-id, #country-filter, #city-filter, #date-from, #date-to").on("change",(function(){console.log("Filter changed:",e(this).attr("id"),e(this).val()),clearTimeout(o),o=setTimeout(a,300)})),e("#search-term").on("input",(function(){console.log("Search input:",e(this).val()),clearTimeout(o),o=setTimeout(a,500)})),e("#search-term").on("keypress",(function(e){13===e.which&&(clearTimeout(o),a())})),e(".cfgeo-clear-filters").on("click",(function(o){o.preventDefault(),e("#form-id").val("all"),e("#country-filter").val(""),e("#city-filter").val(""),e("#date-from").val(""),e("#date-to").val(""),e("#search-term").val(""),e('input[name="orderby"]').val("date"),e('input[name="order"]').val("DESC"),e('input[name="paged"]').val("1"),a()})),e("#date-from, #date-to").on("change",(function(){var o=e("#date-from").val(),t=e("#date-to").val();o&&t&&o>t&&(alert(cfgeo_ajax.date_error_message),e(this).val(""))})),e(document).on("click",".tablenav-pages a",(function(o){o.preventDefault();var t=e(this).data("page")||"1";e('input[name="paged"]').val(t),a()})),e(document).on("click",".wp-list-table th.sortable a, .wp-list-table th.sorted a",(function(o){o.preventDefault();var t=e(this).attr("href"),r=new URL(t),n=r.searchParams.get("orderby")||"date",i=r.searchParams.get("order")||"DESC";e('input[name="orderby"]').val(n),e('input[name="order"]').val(i),e('input[name="paged"]').val("1"),a()}));var r=e(".wp-list-table tbody tr").length;if(r>0){var n=e('<div class="cfgeo-filter-count">Showing '+r+" submission(s)</div>");e(".cfgeo-advanced-filters").append(n)}}else console.log("CFGEO Debug: Not on CFGEO page or cfgeo_ajax not available, skipping AJAX initialization");e("#test-webhook").length&&"undefined"!=typeof cfgeo_ajax&&e("#test-webhook").on("click",(function(){var o=e(this),t=o.text();o.prop("disabled",!0).text("Testing..."),e("#webhook-test-result").hide(),e.ajax({url:ajaxurl,type:"POST",data:{action:"cfgeo_test_webhook",nonce:cfgeo_ajax.webhook_test_nonce||cfgeo_ajax.nonce},success:function(o){if(o&&o.success){var t=o.data&&o.data.message?o.data.message:"Test completed successfully!";e("#webhook-test-result").html('<div class="notice notice-success"><p>'+t+"</p></div>").show()}else{t=o&&o.data&&o.data.message?o.data.message:"Test failed. Please try again.";e("#webhook-test-result").html('<div class="notice notice-error"><p>'+t+"</p></div>").show()}},error:function(){e("#webhook-test-result").html('<div class="notice notice-error"><p>An error occurred while testing the webhook.</p></div>').show()},complete:function(){o.prop("disabled",!1).text(t)}})})),e("#webhook-logs").length&&"undefined"!=typeof cfgeo_ajax&&function(){if("undefined"==typeof cfgeo_ajax)return void(e("#webhook-logs").html('<p class="description">Unable to load webhook logs - AJAX not available.</p>'),e("#clear-webhook-logs").prop("disabled",!0));e.ajax({url:ajaxurl,type:"POST",data:{action:"cfgeo_get_webhook_logs",nonce:cfgeo_ajax.webhook_logs_nonce||cfgeo_ajax.nonce},success:function(o){if(o&&o.success&&o.data&&o.data.logs){var t="";o.data.logs.length>0?(e("#clear-webhook-logs").prop("disabled",!1),o.data.logs.forEach((function(e){var o=e.success?"success":"error",a=e.success?"Success":"Failed";t+='<div class="webhook-log-entry '+o+'">',t+="<strong>"+a+"</strong> - "+(e.timestamp||"Unknown time")+"<br>",t+="<small>URL: "+(e.url||"Unknown URL")+"</small><br>",t+="<small>Response: "+(e.response_code||"Unknown")+" - "+(e.response_message||"No message")+"</small>",t+="</div>"}))):(e("#clear-webhook-logs").prop("disabled",!0),t='<p class="description">No webhook logs available yet.</p>'),e("#webhook-logs").html(t)}else e("#webhook-logs").html('<p class="description">Unable to load webhook logs - invalid response format.</p>'),e("#clear-webhook-logs").prop("disabled",!0)},error:function(){e("#webhook-logs").html('<p class="description">Unable to load webhook logs.</p>'),e("#clear-webhook-logs").prop("disabled",!0)}})}(),e("#clear-webhook-logs").length&&"undefined"!=typeof cfgeo_ajax&&e("#clear-webhook-logs").on("click",(function(){if(confirm("Are you sure you want to clear all webhook logs? This action cannot be undone.")){var o=e(this),t=o.text();o.prop("disabled",!0).text("Clearing..."),e.ajax({url:ajaxurl,type:"POST",data:{action:"cfgeo_clear_webhook_logs",nonce:cfgeo_ajax.webhook_logs_nonce||cfgeo_ajax.nonce},success:function(o){if(o&&o.success){e("#webhook-logs").html('<p class="description">No webhook logs available yet.</p>'),e("#clear-webhook-logs").prop("disabled",!0);var t=o.data&&o.data.message?o.data.message:"Webhook logs cleared successfully.";e("#webhook-logs").before('<div class="notice notice-success" style="margin-bottom: 10px;"><p>'+t+"</p></div>"),setTimeout((function(){e("#webhook-logs").prev(".notice").fadeOut()}),3e3)}else{t=o&&o.data&&o.data.message?o.data.message:"Failed to clear webhook logs.";e("#webhook-logs").before('<div class="notice notice-error" style="margin-bottom: 10px;"><p>'+t+"</p></div>")}},error:function(){e("#webhook-logs").before('<div class="notice notice-error" style="margin-bottom: 10px;"><p>An error occurred while clearing webhook logs.</p></div>')},complete:function(){o.prop("disabled",!1).text(t)}})}}))}))}(jQuery);